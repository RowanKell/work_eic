# Notes Wed June 19

## Neural Network approach

#### Feature spaces

(100k events - 80k train 20k test, 50-50 split pi/mu)

1. EDep per layer (28)
   1. 50% accuracy
2. pixels per layer (28)
   1. 91.755% accuracy



This makes 0 sense

#### model exploration

dropout

1. On pixels per layer: 91.135

L1/L2 normalization

Activation functions (ReLU as default):

1. Tanh
   1.  89.005%
2. Sigmoid
   1. 50% accuracy
3. LeakyReLU
   1. 91.78
4. SiLU
   1. 91.7
5. GELU
   1. 91.74

## Fitting z dependence on % of photons reaching sensor

![image-20240619164627594](/home/rowan/.config/Typora/typora-user-images/image-20240619164627594.png)

### function:

a / (x + b) + c

1. a = 494.98
2. b = 9.9733
3. c = -0.16796

### Result

1. seems that adding the z dependence lowers accuracy to 85%...

# Notes

1. If ever gettinga a mysterious CUDA error, switch device to cpu and run again - will get actual error







# KLM Meeting - 2pm



Questions / assumptions

1. scintillator bar length - is 1.5 or 2.5 a better option to work with right now?
2. SiPM - how large are they, how many per bar, how many pixels?
   1. Anything else about how we can more accurately model them in the simulation

meeting notes

1. timing + SiPM shape
   1. look at multiple arrivals - first staircase, then pulse shape - need to throw in dark arrivals
   2. just put active area of sipms in right place on bar - 12 4x4mm points - 2x6 array of - 4050HS
   3. ideally need a distribution for each photon, then draw a time for each photon
   4. need to know what the answer for timing
2. simulate a range of lengths and scintillator materials
3. 

next steps for me

1. May want to look at timing parametrization
   1. See time of hit for photons generated by hits at different positions - can we just use position as input and nothing else

# Notes Friday June 21st

Timing

1. Use z position as parameter
2. Parameterize for each photon for each hit?

Plan

1. Use optical photon one layer setup
2. Simulate opt ph over a range of theta
3. for each photon, 



## New plan - Timing

### Angle

1. Look at angle dependence of timing info
2. See if the shape of the timing distribution depends on angle
3. Plan
   1. Shoot from different positions to hit one spot at different angles

### Test if # of photons independent of timing distribution

1. Bin by energy and see if distributions are different at diff energies
   1. I.e if 1GeV and 5GeV have same timing distributions then we are good



# Group meeting

1. Run some EIC events through my affinity calculations, see if me and penn get the same thing
2. solenoid
   1. 2.5 tesla
   2. 120 cm
3. lower momenta -> higher angle -> more iron



EIC sim

1. is there a dependence of timing distribution on track angle
   1. could be that the emission angle is depending on the track angle





# June 24

## Mu Pi separation

1. Ian's code works well for 1GeV pions and muons at fixed theta, but seems like when theta is varied the accuracy will go down as more muons stop after first few layers (not sure why)

## Timing resolution

### Independence of primary energy and timing distribution

1. Need to bin timing distribution by energy
2. Seems that energy and timing distribution are uncorrelated, hard to tell exactly though

![](/home/rowan/Downloads/travel_time_energy_10k_20_bins.jpeg)

### Independence of # photons (energy dep) and timing

1. Unclear if there is a correlation or not, may need to run more events to get higher statistics

![](/home/rowan/Downloads/travel_time_num_photons_10k_20_bins.jpeg)

1. Need to run simulation where we get different angles / diff energy deposit and diff # of photons without the # photons being correlated with the position (and hence the travel time)

## New sim: same hit position with different angles / energy deposits

1. Needed some data where the travel distance of the photons is constant (to not affect timing) but the energy deposit (and hence # of photons) is varied. By just changing theta we change the hit position too, so we need to adjust the gun position such that we always hit the same position (like a focal point). Data is running as of 6/24 5pm, needs to be analyzed tomorrow
   1. Should make similar plots to the ones before, this time with # of optical photons or energy dep or theta angle as the x axis (and binning) and the travel time on the y axis

# June 25

1. Ran the simulations and now have plots for those
   1. Seems like theres a correlation with angle but this seems to just be related to the position of the hit, not the energy dep/# of photons as the range of deviation is so small
   2. Likely what happened (and this seems to be true) is that the angles + gun positions line up the entry point of the particle, but the track goes through different points, so the average z value across all hits is directly proportional to the angle, hence we see a linear slope

# June 26

1. Investigating second peak
   1. Maybe from photons produced by secondaries? Now cutting out photons produced by secondaries
   2. Appears that cutting out secondaries fixes the issue, we now get a pretty clean distribution

## Normalizing flows to model the timing pdf

1. Can use regular normalizing flow and bin by position
2. Can try conditional flow where the conditional variable is the position

First test

1. Normalizing flow with 1 feature, travel time

Other idea

1. Use one travel time distribution from middle of bar, then add or subtract time as a function of the z position

### Emission time

1. Travel time is needed, but emission time is also needed if photons are emitted at different times from the hit time of the charged track 

##### Need to calculate

1. Idea: shoot from diff x positions where the time it takes for the mu to travel to the scintillator is measurable so we can make sure emission time is shifted according to this distance
   1. If we move the particle gun back, the emission time should be shifted x / v nanoseconds
2. Currently investigating with 0.1 GeV muon gun to see if there is any dependence on gun x position

![image-20240627121347119](/home/rowan/.config/Typora/typora-user-images/image-20240627121347119.png)

From this we can clearly see that the emission time (means) are linear to the x_pos. Thus, we must parameterize the emission time by taking a distribution of the emission times and shifting it based on the hit time

##### Current parameterization overview

Overview

1. Main aspects
   1.  \# of photons
      1. Calculated using $\frac{1}{x}$​​ where x is the z position of hit
         1. Variation_percent.ipynb
      2. Take fraction of photons that reach sensor based on hit position
   2. Timing
      1. Draw from distribution of emission times
         1. x_pos.ipynb
      2. Draw from distribution of travel times
         1. Variation_time.ipynb
      3. Use one bar simulation to get these distributions
         1. Only use photons that reach sensor
         2. Emission time after hit has distribution, time between gun and hit can be calculated using energy and distance
   3. Together, should give us timing for every pixel, and we can use this to calculate the pulse shape of the SiPM output.

# June 28

## Timing Parameterization

##### Emission times

1. Data preparation
   1. Need to shift distribution to have lower limit of 0, maybe just shoot from 0.1 mm away
      1. Seems that the first optical photons are generated at 1770.3, so maybe shoot at 1770.29
   2. Model distribution with normalizing flow (one dimension/feature)

##### Travel Times

1. Data preparation
   1. Need to run simulations on a range of theta and positions (try to run multiple batches at diff positions then vary theta for each position to avoid correlation)
2. model
   1. Conditional nf, 2d gaussian
   2. Train with 2 features, z  position and travel time (time between emission and arrival time)

## NEED TO CHECK

1. Need to check the hit time of the muon when scint. is sensitive vs the beginning of the emission distribution
   1. If these have same value, start emission distribution at the hit time
   2. If the emission dist. is shifted, need to account for this somehow in parameterization
   3. My thought is that the hit might be in the center of the scint material, so it is unclear if the time is when it hits the center, at the beginning, the end, etc. So we can check by shooting from same place and comparing optph emission and mu hit time across many diff events even if we can't check event by event

##### Don't need two sep runs, can just use the run with scint sensitive

1. If scint sensitive, we know the muon hit time and the optph emission time, so long as we simulate optph
   1. We can use this info to get a distribution for the emission time as a function of the mu hit time

## Mu track time and position

Each muon produces about 7 hits per mm, so in 10 mm we get 70 (sometimes 71 or 72) hits, and the time and position is exactly what you expect:

![image-20240628155335827](/home/rowan/.config/Typora/typora-user-images/image-20240628155335827.png)

This plot shows the average track hit time and x position for the 0th, 1st, etc mu track hit

Below we can see that the photon emission time is delayed compared to the track time hit, and the hit position doesn't correlate with the emission time:

![image-20240628161324306](/home/rowan/.config/Typora/typora-user-images/image-20240628161324306.png)

##### End of day note

1. running 10k events at 1769 x gun pos, 5GeV, scint sens and optph on. Can then use this to train NN supposedly
   1. Now we know that the charged track hits in scint are realistic both in time and position, so we just need to relate the hits to the optical photons produced, maybe just shorted the bar to the minimum for a single hit so that we know that the photons are being generated from the hit; otherwise not sure we can tell which photons come from which hits.
   2. Then we can see the distribution of photon emission times for a hit (and get a relative emission time spectrum)
   3. Then we just need to fit the travel time which know photon by photon, so we can just bin by z position of the track hit, and then integrate over everything else
      1. For the z hit position, need to make sure that we know the z position
         1. Either shoot directly orthogonal to z axis, or shoot at thin bar with only 1 hit

# Notes July 1st

### Parameterization

big picture: two things to parameterize

1. Emission time 
2. Travel time

Original idea: use a 2d normalizing flow to learn the travel time, and 1d NF to learn the emission time

1. Travel time:
   1. 2d flow: first variable is the conditional: z position; second is the travel time
   2. 
2. Emission time:
   1. 1d flow: just flow from gaussian to a distribution of the emission times

Combination idea

1. Combine all into one flow:
   1. Take the z hit position, and model the pdf of the time between hcalhit and sensor hit
   2. one feature: time
   3. one conditional: z hit position
2. This only works if the hcalbarrelhit time is deterministic
   1. Seems from a quick look at the data that 99.5% of the hits are at the exact same time
   2. However, seems like there is no way to tell which optical photons are created by which hits
      1. May need to use thin bar where there is only 1 hit to parameterize the optical photon generation as a function of the charged track hit time

##### New idea

1. Use the kinematics as our conditionals, go directly to time of arrival of photons on sensor
2. Conditionals
   1. hit z position (maybe x and y?)
   2. hit time
   3. hit angle (phi and theta or just theta?) start with theta, can investigate phi later
   4. hit momentum
3. Features
   1. photon hit time on sensor
   2. 

###### New sim run

1. Need range of angles, z hit pos, energies, constant x pos (1760.3)
2. z pos: 767->-732
3. theta: based on z pos
4. Calculate time of hit by using momentum
   1. velocity = momentum / mass (GeV/c divided by GeV/c^2)
   2. E = gamma * m
      1. 
      2. p = 5 GeV/c
      3. m = 0.1056 GeV/c^2
   3. This gives 
   4. 

Calculating time of travel for a relativistic particle given mass, momentum, and distance traveled:

$P = \gamma * mv = \frac{mv}{\sqrt{1-\frac{v^2}{c^2}}}$

$P/m = \frac{v}{\sqrt{1 - \frac{v^2}{c^2}}} \rightarrow (1 - \frac{v^2}{c^2})*(P/m)^2 = v^2 \rightarrow (P/m)^2 - (P/m)^2 * (\frac{v}{c})^2 = v^2$

$v^2(1 + (\frac{P}{mc})^2) = (P/m)^2 \rightarrow v^2 = \frac{(P/m)^2}{1 + (P/m)^2 * \frac{1}{c^2}}$

$v = (P/m) * \sqrt{\frac{1}{1 + (P/m)^2 * \frac{1}{c^2}}}$

$v = \frac{dx}{dt} \rightarrow dt = \frac{dx}{v}$
\\
\\
example: 5GeV/c momentum, 0.105658 GeV/$c^2$ mass (mu-), 1mm traveled:

$P/m = 47.322 c \rightarrow v = (P/m) * \alpha $ for $\alpha = \sqrt{\frac{1}{1 + (P/m)^2 * \frac{1}{c^2}}} $\\
convert to m/s, assuming v = 0.2c:

$v = 0.2c = 0.2 * 2.998*10^8 m/s = 5.996*10^7 m/s$\\
convert to mm/s:

$v = 5.996*10^7 m/s * \frac{1000 mm}{m} = 5.996 * 10^10 mm/s$\\
convert to mm/ns:

$v = 5.996 * 10^10 mm/s * \frac{1 s}{10^9 ns} = 59.96 mm/ns$\\
now find dt:

$dt = \frac{1 mm}{59.96 mm/ns} = 0.01668 ns$

# Affinity

## Big picture

Plots for tomorrow

1. Affinity binned by x, z_h, qTQ
   1. Box affinity original
   2. Box affinity with new R2?
   3. Estimation affinity original
   4. Driver affinity original
   5. Driver affinity with new R2 (R_2 = qT/Q ^2)
2. Histograms
   1. Ratios for driver and box
   2. Masses

## Affinity plots

1. Options
   1. Partonic variables
      1. Driver
      2. MC
   2. R2 calculation
      1. Original
      2. qT\^2/Q\^2